<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AMMAR//i\\CADEMY - Cosmic AI</title>

  <!-- Puter.js -->
  <script src="https://js.puter.com/v2/"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:#f0ebe1;color:#1e1e2e;
      min-height:100vh;display:flex;justify-content:center;align-items:center;padding:0
    }
    .container{
      width:100vw;height:100vh;background:rgba(255,255,255,.85);
      backdrop-filter:blur(10px);
      display:flex;flex-direction:column
    }
    header{text-align:center;flex-shrink:0;margin-bottom:0}
    .brand{text-align:center;margin:4px auto 2px}
    .brand .gold{color:#D4AF37;font-size:1rem;font-weight:700;letter-spacing:.5px;text-shadow:0 2px 4px rgba(0,0,0,.1)}
    .brand .sub{color:#5a5a7a;font-size:.6rem;font-weight:400;text-shadow:0 1px 2px rgba(0,0,0,.05);margin-top:1px}

    .chat-container{display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden}
    .chat-messages{
      flex:1;overflow-y:auto;padding:15px;min-height:0;
      box-shadow: inset 0 0 20px rgba(255,255,255,.6),0 4px 15px rgba(0,0,0,.05);
      background:rgba(255,255,255,.3);
      border-radius:20px 20px 0 0;margin:0 5px
    }

    .message{margin-bottom:10px;display:flex;flex-direction:column}
    .message.user{align-items:flex-end}
    .message.assistant{align-items:flex-start}
    .message.system{align-items:center}

    .message .content-wrapper{display:flex;flex-direction:column;align-items:flex-start;max-width:80%}
    .message.user .content-wrapper{align-items:flex-end}

    .message .content{
      padding:6px 12px;border-radius:15px;color:#1e1e2e;
      font-size:.92em;line-height:1.45;
      box-shadow:0 2px 8px rgba(255,255,255,.5),0 2px 5px rgba(0,0,0,.05);
      border:1px solid rgba(255,215,0,.2);word-break:break-word
    }
    .message.user .content{background:rgba(255,255,240,.7)}
    .message.assistant .content{background:rgba(255,255,240,.9)}
    .message.system .content{background:rgba(249,226,175,.9)}

    .copy-under{
      background:rgba(255,255,255,.5);border:none;border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,.1);
      cursor:pointer;font-size:.7rem;padding:2px 8px;margin-top:4px;color:#333;transition:.2s;display:inline-block
    }
    .copy-under:hover{background:rgba(255,255,255,.8);box-shadow:0 4px 8px rgba(0,0,0,.15)}
    .copy-under.copied{background:#4CAF50;color:#fff;box-shadow:none}

    .message .time{font-size:.55em;color:#5a5a7a;margin-top:3px;margin-left:5px}

    .input-frame{
      margin-left:.5cm;margin-right:.5cm;height:4cm;
      background:rgba(255,255,255,.6);
      border:1px solid rgba(255,215,0,.3);
      border-radius:20px;backdrop-filter:blur(5px);
      padding:6px 10px;display:flex;flex-direction:column;justify-content:space-between;
      box-shadow:0 8px 20px rgba(255,255,255,.3),0 2px 5px rgba(0,0,0,.05);
      margin-bottom:5px
    }
    .input-row{display:flex;align-items:center;gap:5px}
    .input-row textarea{
      flex:1;padding:6px 10px;border-radius:20px;
      border:2px solid rgba(212,175,55,.6);
      background:#fff;color:#1e1e2e;
      font-size:1em;line-height:1.45;
      resize:none;font-family:inherit;
      box-shadow: inset 0 2px 5px rgba(0,0,0,.03),0 2px 5px rgba(255,215,0,.1);
      height:1.8cm;min-height:1.8cm;outline:none
    }
    .circle-send{
      width:38px;height:38px;border-radius:50%;
      background:#fff;border:2px solid #D4AF37;
      box-shadow:0 4px 10px rgba(212,175,55,.2);
      display:flex;align-items:center;justify-content:center;
      font-size:1.8rem;cursor:pointer;transition:.2s;color:#D4AF37;flex-shrink:0;line-height:1;
      user-select:none;-webkit-tap-highlight-color:transparent
    }
    .circle-send:hover{background:rgba(212,175,55,.1);transform:scale(1.05)}
    .circle-send:active{transform:scale(.98)}

    .compact-row{display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap}
    .upload-icon-small{background:none;border:none;font-size:1.1rem;cursor:pointer;color:#2d2d3a;transition:.2s;padding:0 3px}
    .upload-icon-small:hover{color:#D4AF37}

    .small-btn{
      background:rgba(255,255,255,.9);
      border:2px solid #D4AF37;border-radius:30px;
      padding:3px 10px;font-size:.75rem;font-weight:600;color:#1e1e2e;cursor:pointer;transition:.2s;
      box-shadow:0 4px 8px rgba(212,175,55,.1);
      backdrop-filter:blur(4px);white-space:nowrap
    }
    .small-btn:hover{background:rgba(212,175,55,.15);transform:translateY(-2px)}
    .small-btn.active{background:rgba(212,175,55,.25);border-color:#b8860b}

    .model-selector select{
      padding:3px 8px;border-radius:20px;border:1px solid #D4AF37;
      background:#fff;color:#1e1e2e;font-size:.7rem;cursor:pointer
    }
    .hidden-check{display:none}

    footer{
      text-align:center;margin-top:2px;color:#5a5a7a;font-size:.6rem;
      border-top:1px solid rgba(212,175,55,.2);padding-top:2px;flex-shrink:0
    }

    .codeblock{
      margin:8px 0;border-radius:14px;overflow:hidden;
      border:1px solid rgba(0,0,0,.10);background:#0b1020;color:#e9eefc;
      box-shadow:0 6px 14px rgba(0,0,0,.12)
    }
    .codebar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:8px 10px;background:rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.10);user-select:none
    }
    .codebar .lang{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;color:rgba(233,238,252,.75);display:flex;align-items:center;gap:8px
    }
    .codebar .dot{width:7px;height:7px;border-radius:999px;background:rgba(212,175,55,.9);box-shadow:0 0 0 3px rgba(212,175,55,.18)}
    .codebtn{
      border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.08);
      color:#e9eefc;font-size:12px;padding:6px 10px;border-radius:10px;cursor:pointer;transition:.15s
    }
    .codebtn:hover{background:rgba(255,255,255,.12);transform:translateY(-1px)}
    .codebtn.copied{border-color:rgba(34,197,94,.6);background:rgba(34,197,94,.16);color:#bbf7d0;transform:none}
    pre{
      margin:0;padding:12px;overflow:auto;white-space:pre;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:13px;line-height:1.45
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="gold">AMMAR//i\\CADEMY</div>
        <div class="sub">Ammar Nasir Hussein al-mantafji 2026</div>
      </div>
    </header>

    <div class="chat-container">
      <div class="chat-messages" id="chatMessages"></div>

      <div class="input-frame">
        <input type="checkbox" id="voiceOutput" class="hidden-check">
        <input type="checkbox" id="internetSearch" class="hidden-check">

        <div class="input-row">
          <textarea id="userInput" placeholder="Type your message here..." rows="1"></textarea>
          <button class="circle-send" id="sendBtn" type="button" aria-label="Send">‚Üë</button>
        </div>

        <div class="compact-row">
          <button class="upload-icon-small" id="uploadBtn" title="Upload image">üìé</button>
          <button class="small-btn" id="deepThinkBtn">DeepThink</button>
          <button class="small-btn" id="searchBtn">Search</button>
          <div class="model-selector">
            <select id="modelSelect">
              <option value="deepseek-r1" selected>DeepSeek R1</option>
              <option value="gpt-5-nano">GPT-5 Nano</option>
              <option value="claude-opus-4">Claude Opus 4</option>
              <option value="gemini-2.0-pro">Gemini 2.0 Pro</option>
            </select>
          </div>
        </div>

        <input type="file" id="fileInput" accept="image/*" style="display:none;">
      </div>
    </div>

    <footer>‚ö° No API keys ‚Ä¢ Puter.js ‚Ä¢ to infinity ‚ú®</footer>
  </div>

  <script>
    (function(){
      const chatMessages = document.getElementById('chatMessages');
      const userInput = document.getElementById('userInput');
      const sendBtn = document.getElementById('sendBtn');
      const voiceOutput = document.getElementById('voiceOutput');
      const internetSearch = document.getElementById('internetSearch');
      const modelSelect = document.getElementById('modelSelect');
      const uploadBtn = document.getElementById('uploadBtn');
      const fileInput = document.getElementById('fileInput');
      const deepThinkBtn = document.getElementById('deepThinkBtn');
      const searchBtn = document.getElementById('searchBtn');

      let deepThinkActive = false;
      let searchActive = false;

      const responseCache = new Map();

      function autoGrow(){
        userInput.style.height = "auto";
        userInput.style.height = Math.min(userInput.scrollHeight, 140) + "px";
      }
      userInput.addEventListener("input", autoGrow);

      function escapeHtml(s){
        return String(s ?? "")
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
      }
      function guessLang(code){
        const t = code.trim();
        if(/^<!doctype html>|^<html/i.test(t)) return "html";
        if(/\b(function|const|let|=>|document\.getElementById|addEventListener)\b/.test(t)) return "javascript";
        if(/\b(def |import |print\(|class )\b/.test(t)) return "python";
        return "code";
      }
      function renderContentToHTML(text){
        const raw = String(text ?? "");
        const parts = raw.split(/```/g);
        let html = "";

        for(let i=0;i<parts.length;i++){
          if(i % 2 === 1){
            const seg = parts[i];
            const m = seg.match(/^([a-zA-Z0-9_+-]+)\n([\s\S]*)$/);
            const lang = (m ? m[1] : guessLang(seg)).toLowerCase();
            const code = (m ? m[2] : seg).replace(/\n$/, "");
            const safeCode = escapeHtml(code);

            html += `
              <div class="codeblock">
                <div class="codebar">
                  <div class="lang"><span class="dot"></span><span>${escapeHtml(lang)}</span></div>
                  <button class="codebtn" onclick="(function(btn){
                    const root = btn.closest('.codeblock');
                    const pre = root.querySelector('pre');
                    const txt = pre ? pre.innerText : '';
                    navigator.clipboard.writeText(txt).then(()=>{
                      btn.classList.add('copied'); btn.textContent='Copied';
                      setTimeout(()=>{ btn.classList.remove('copied'); btn.textContent='Copy code'; }, 1200);
                    }).catch(()=>{ btn.textContent='Failed'; setTimeout(()=>btn.textContent='Copy code',1200); });
                  })(this)">Copy code</button>
                </div>
                <pre><code>${safeCode}</code></pre>
              </div>
            `;
          } else {
            html += escapeHtml(parts[i]).replace(/\n/g, "<br>");
          }
        }
        return html;
      }

      window.copyText = function(element, text) {
        navigator.clipboard.writeText(text).then(() => {
          element.classList.add('copied');
          element.textContent = '‚úì copied';
          setTimeout(() => {
            element.classList.remove('copied');
            element.textContent = 'copy';
          }, 1500);
        }).catch(() => alert('Failed to copy text'));
      };

      function speakText(text) {
        try{
          const u = new SpeechSynthesisUtterance(text);
          u.lang = 'en-US';
          u.rate = 1; u.pitch = 1;
          speechSynthesis.speak(u);
        }catch(_){}
      }

      function addMessage(role, content, isHtml=false){
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${role}`;

        const wrapper = document.createElement('div');
        wrapper.className = 'content-wrapper';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'content';
        if(isHtml) contentDiv.innerHTML = content;
        else contentDiv.textContent = content;

        wrapper.appendChild(contentDiv);

        const copyUnder = document.createElement('span');
        copyUnder.className = 'copy-under';
        copyUnder.textContent = 'copy';
        copyUnder.onclick = function(){
          const txt = contentDiv.innerText || contentDiv.textContent || "";
          copyText(this, txt);
        };
        wrapper.appendChild(copyUnder);

        msgDiv.appendChild(wrapper);

        const timeSpan = document.createElement('span');
        timeSpan.className = 'time';
        timeSpan.textContent = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
        msgDiv.appendChild(timeSpan);

        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        if(role === 'assistant' && voiceOutput.checked){
          speakText(contentDiv.innerText);
        }
      }

      // Errors to chat
      window.addEventListener('error', (ev) => {
        try{ addMessage('system', `‚ùå JS Error: ${ev.message}`); }catch(_){}
      });
      window.addEventListener('unhandledrejection', (ev) => {
        try{ addMessage('system', `‚ùå Promise Error: ${ev.reason?.message || ev.reason}`); }catch(_){}
      });

      deepThinkBtn.addEventListener('click', () => {
        deepThinkActive = !deepThinkActive;
        if(deepThinkActive){
          modelSelect.value = 'deepseek-r1';
          deepThinkBtn.classList.add('active');
        }else{
          deepThinkBtn.classList.remove('active');
        }
      });

      searchBtn.addEventListener('click', () => {
        searchActive = !searchActive;
        internetSearch.checked = searchActive;
        searchBtn.classList.toggle('active', searchActive);
      });

      uploadBtn.addEventListener('click', () => fileInput.click());

      async function chatWithAI(message){
        const cacheKey = modelSelect.value + ":" + message;
        if(responseCache.has(cacheKey)) return responseCache.get(cacheKey);

        if(!window.puter || !puter.ai || !puter.ai.chat){
          return "‚ö†Ô∏è Puter.ai not available. Check internet / script loading.";
        }

        const len = (message || "").length;
        const dynamicMaxTokens =
          len < 80  ? 280 :
          len < 180 ? 450 :
          len < 400 ? 700 :
                      1000;

        const options = { model: modelSelect.value, max_tokens: dynamicMaxTokens };
        if(modelSelect.value !== "deepseek-r1") options.temperature = 0.7;

        const withTimeout = (promise, ms) =>
          Promise.race([
            promise,
            new Promise((_, reject) => setTimeout(() => reject(new Error("timeout")), ms))
          ]);

        try{
          const resp = await withTimeout(puter.ai.chat(message, options), 12000);
          responseCache.set(cacheKey, resp);
          if(responseCache.size > 100) responseCache.delete(responseCache.keys().next().value);
          return resp;
        }catch(_){
          try{
            const retryOpts = { model: modelSelect.value, max_tokens: Math.min(dynamicMaxTokens, 650) };
            if(modelSelect.value !== "deepseek-r1") retryOpts.temperature = 0.7;
            const resp2 = await withTimeout(puter.ai.chat(message, retryOpts), 9000);
            responseCache.set(cacheKey, resp2);
            if(responseCache.size > 100) responseCache.delete(responseCache.keys().next().value);
            return resp2;
          }catch(__){
            return "‚è≥ Took too long. Please try again (or shorten the question).";
          }
        }
      }

      // Image upload analysis
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file) return;

        addMessage('user', 'üì∑ [Image uploaded]');

        const reader = new FileReader();
        reader.onload = async (ev) => {
          const imageData = ev.target.result;
          try{
            if(!window.puter || !puter.ai || !puter.ai.chat){
              addMessage('system', "‚ö†Ô∏è Puter.ai not available for image analysis.");
              return;
            }
            let res;
            try{
              res = await puter.ai.chat("Analyze this image in detail, tell me what you see.", imageData, { model: modelSelect.value });
            }catch(err){
              res = "‚ö†Ô∏è Image analysis not supported in this environment/account.";
            }
            addMessage('assistant', renderContentToHTML(res), true);
          }catch(err){
            addMessage('system', `‚ùå Error analyzing image: ${err?.message || String(err)}`);
          }
        };
        reader.readAsDataURL(file);
        e.target.value = "";
      });

      async function doSend(){
        const text = (userInput.value || "").trim();
        if(!text) return;

        addMessage('user', text);
        userInput.value = "";
        autoGrow();

        let finalText = text;
        if(internetSearch.checked){
          finalText = text + " (please include up-to-date information from the internet if possible)";
        }

        // ‚úÖ HERE: only "Thinking..." (no model name)
        addMessage('system', 'Thinking...');

        const resp = await chatWithAI(finalText);
        addMessage('assistant', renderContentToHTML(resp), true);
      }

      // Guaranteed send bindings
      sendBtn.addEventListener('click', (e)=>{ e.preventDefault(); doSend(); });
      sendBtn.onclick = doSend;
      sendBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); doSend(); }, {passive:false});
      document.addEventListener('click', (e)=>{ if(e.target && e.target.id === 'sendBtn') doSend(); });

      // Enter to send (Shift+Enter = newline)
      userInput.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          doSend();
        }
      });

      addMessage('system', 'Welcome to the infinite space! Type and press Enter or ‚Üë to send.');
    })();
  </script>
</body>
</html>
