<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AMMAR//i\\CADEMY - Cosmic AI</title>

  <!-- Optional Provider (if available) -->
  <script src="https://js.puter.com/v2/"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:#f0ebe1;color:#1e1e2e;
      min-height:100vh;display:flex;justify-content:center;align-items:center;
    }
    .app{
      width:100vw;height:100vh;
      background:rgba(255,255,255,.85);
      backdrop-filter:blur(10px);
      display:flex;flex-direction:column;
      overflow:hidden;
    }
    .topbar{
      height:44px;
      display:flex;align-items:center;justify-content:space-between;
      padding:6px 10px;
      border-bottom:1px solid rgba(212,175,55,.2);
      user-select:none;flex-shrink:0;
    }
    .hamburger{
      width:38px;height:38px;border-radius:12px;
      border:2px solid rgba(212,175,55,.55);
      background:rgba(255,255,255,.92);
      box-shadow:0 4px 10px rgba(212,175,55,.14);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      transition:.2s;
    }
    .hamburger:hover{background:rgba(212,175,55,.12);transform:translateY(-1px)}
    .hamburger .lines{width:16px;height:12px;display:flex;flex-direction:column;justify-content:space-between}
    .hamburger .lines span{height:2px;border-radius:2px;background:#1e1e2e;opacity:.85}
    .brand{
      font-weight:800;color:#D4AF37;font-size:.95rem;letter-spacing:.4px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      text-align:center;flex:1;
    }
    .topbar .spacer{width:38px;height:38px}

    .chat-container{display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden}
    .chat-messages{
      flex:1;overflow-y:auto;padding:15px;min-height:0;
      box-shadow:inset 0 0 20px rgba(255,255,255,.6),0 4px 15px rgba(0,0,0,.05);
      background:rgba(255,255,255,.3);
      border-radius:20px 20px 0 0;
      margin:10px 10px 0 10px;
    }

    .message{margin-bottom:10px;display:flex;flex-direction:column}
    .message.user{align-items:flex-end}
    .message.assistant{align-items:flex-start}
    .message.system{align-items:center}
    .message .content-wrapper{display:flex;flex-direction:column;align-items:flex-start;max-width:80%}
    .message.user .content-wrapper{align-items:flex-end}
    .message .content{
      padding:6px 12px;border-radius:15px;color:#1e1e2e;
      font-size:0.9em;line-height:1.35;
      box-shadow:0 2px 8px rgba(255,255,255,.5),0 2px 5px rgba(0,0,0,.05);
      border:1px solid rgba(255,215,0,.2);
      word-break:break-word;white-space:pre-wrap;
      background:rgba(255,255,240,.9);
    }
    .message.user .content{background:rgba(255,255,240,.7)}
    .message.system .content{background:rgba(249,226,175,.9)}

    .copy-under{
      background:rgba(255,255,255,.5);
      border:none;border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,.1);
      cursor:pointer;font-size:.7rem;
      padding:2px 8px;margin-top:4px;color:#333;
      transition:.2s;display:inline-block;user-select:none;
    }
    .copy-under:hover{background:rgba(255,255,255,.8);box-shadow:0 4px 8px rgba(0,0,0,.15)}
    .copy-under.copied{background:#4CAF50;color:#fff;box-shadow:none}
    .message .time{font-size:.55em;color:#5a5a7a;margin-top:3px;margin-left:5px}

    .input-frame{
      margin:0 10px 10px 10px;height:4.2cm;
      background:rgba(255,255,255,.6);
      border:1px solid rgba(255,215,0,.3);
      border-radius:20px;backdrop-filter:blur(5px);
      padding:6px 10px;display:flex;flex-direction:column;
      justify-content:space-between;
      box-shadow:0 8px 20px rgba(255,255,255,.3),0 2px 5px rgba(0,0,0,.05);
      flex-shrink:0;
    }
    .input-row{display:flex;align-items:center;gap:6px}
    .input-row textarea{
      flex:1;padding:8px 12px;border-radius:20px;
      border:2px solid rgba(212,175,55,.6);
      background:#fff;color:#1e1e2e;font-size:.9em;
      resize:none;font-family:inherit;
      box-shadow:inset 0 2px 5px rgba(0,0,0,.03),0 2px 5px rgba(255,215,0,.1);
      height:1.9cm;min-height:1.9cm;
      outline:none;
    }
    .circle-send{
      width:38px;height:38px;border-radius:50%;
      background:#fff;border:2px solid #D4AF37;
      box-shadow:0 4px 10px rgba(212,175,55,.2);
      display:flex;align-items:center;justify-content:center;
      font-size:1.8rem;cursor:pointer;transition:.2s;color:#D4AF37;
      flex-shrink:0;line-height:1;user-select:none;
    }
    .circle-send:hover{background:rgba(212,175,55,.1);transform:scale(1.05)}

    .bottom-row{display:flex;align-items:center;justify-content:flex-start;padding:0 6px 2px 6px}
    .icon-btn{
      background:none;border:none;
      font-size:1.15rem;
      cursor:pointer;color:#2d2d3a;
      transition:.2s;padding:0 3px;user-select:none;
    }
    .icon-btn:hover{color:#D4AF37}

    /* Drawer */
    .drawer-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.22);
      display:none;z-index:50;
    }
    .drawer-backdrop.show{display:block}
    .drawer{
      position:fixed;top:0;left:0;height:100vh;width:280px;
      background:rgba(255,255,255,.93);
      backdrop-filter:blur(12px);
      border-right:1px solid rgba(212,175,55,.22);
      box-shadow:12px 0 40px rgba(0,0,0,.12);
      transform:translateX(-100%);
      transition:.22s;
      z-index:60;
      display:flex;flex-direction:column;
    }
    .drawer.show{transform:translateX(0)}
    .drawer-head{
      padding:10px 10px 8px 10px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid rgba(212,175,55,.2);
      user-select:none;
    }
    .drawer-title{font-weight:800;font-size:.85rem}
    .drawer-close{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(212,175,55,.5);
      background:rgba(255,255,255,.9);
      cursor:pointer;
    }
    .newchat-mini{
      width:44px;height:44px;border-radius:14px;
      border:2px solid #D4AF37;
      background:rgba(255,255,255,.95);
      box-shadow:0 4px 10px rgba(212,175,55,.14);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      font-size:1.4rem;font-weight:900;color:#1e1e2e;
      margin:10px 10px 4px 10px;
      user-select:none;
      transition:.2s;
    }
    .newchat-mini:hover{background:rgba(212,175,55,.12);transform:translateY(-1px)}
    .chatlist{padding:6px 8px 12px 8px;overflow:auto;flex:1}
    .chatitem{
      padding:10px 10px;border-radius:14px;
      border:1px solid rgba(212,175,55,.18);
      background:rgba(255,255,255,.68);
      margin:8px 4px;cursor:pointer;
      transition:.15s;user-select:none;
    }
    .chatitem:hover{background:rgba(212,175,55,.10)}
    .chatitem.active{
      background:rgba(212,175,55,.16);
      border-color:rgba(184,134,11,.35);
    }
    .chatitem .title{font-weight:800;font-size:.8rem}
    .chatitem .meta{font-size:.65rem;color:#5a5a7a;margin-top:2px}

    /* Loader */
    .blink{font-weight:900;letter-spacing:2px}
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <button class="hamburger" id="openDrawer" title="Menu">
        <div class="lines"><span></span><span></span><span></span></div>
      </button>
      <div class="brand">AMMAR//i\\CADEMY</div>
      <div class="spacer"></div>
    </div>

    <div class="chat-container">
      <div class="chat-messages" id="chatMessages"></div>

      <div class="input-frame">
        <div class="input-row">
          <textarea id="userInput" placeholder="Type your message here..." rows="1"></textarea>
          <button class="circle-send" id="sendBtn" type="button">â†‘</button>
        </div>

        <div class="bottom-row">
          <button class="icon-btn" id="uploadBtn" title="Upload">ğŸ“</button>
          <input type="file" id="fileInput" style="display:none" />
        </div>
      </div>
    </div>
  </div>

  <div class="drawer-backdrop" id="drawerBackdrop"></div>
  <aside class="drawer" id="drawer">
    <div class="drawer-head">
      <div class="drawer-title">Chats</div>
      <button class="drawer-close" id="closeDrawer" title="Close">âœ•</button>
    </div>
    <div class="newchat-mini" id="newChatBtn" title="New Chat">+</div>
    <div class="chatlist" id="chatList"></div>
  </aside>

  <script>
    // --- absolutely-safe boot: no DOMContentLoaded dependency ---
    (function boot(){
      function $(id){ return document.getElementById(id); }

      function run(){
        const chatMessages = $("chatMessages");
        const userInput    = $("userInput");
        const sendBtn      = $("sendBtn");
        const uploadBtn    = $("uploadBtn");
        const fileInput    = $("fileInput");

        const openDrawerBtn = $("openDrawer");
        const closeDrawerBtn = $("closeDrawer");
        const drawerBackdrop = $("drawerBackdrop");
        const drawer = $("drawer");
        const newChatBtn = $("newChatBtn");
        const chatListEl = $("chatList");

        if(!chatMessages || !userInput || !sendBtn){
          // if DOM not ready yet, retry quickly
          return setTimeout(run, 30);
        }

        // Copy
        window.copyText = function(element, text){
          navigator.clipboard.writeText(text).then(()=>{
            element.classList.add('copied');
            element.textContent = 'âœ“ copied';
            setTimeout(()=>{ element.classList.remove('copied'); element.textContent='copy'; }, 1200);
          }).catch(()=> alert('Failed to copy text'));
        };

        function timeStr(ts){
          return new Date(ts || Date.now()).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
        }

        function addMessage(role, content, ts){
          const msgDiv = document.createElement("div");
          msgDiv.className = `message ${role}`;

          const wrapper = document.createElement("div");
          wrapper.className = "content-wrapper";

          const contentDiv = document.createElement("div");
          contentDiv.className = "content";
          contentDiv.textContent = String(content ?? "");
          wrapper.appendChild(contentDiv);

          const copyUnder = document.createElement("span");
          copyUnder.className = "copy-under";
          copyUnder.textContent = "copy";
          copyUnder.onclick = function(){ copyText(this, contentDiv.textContent || contentDiv.innerText); };
          wrapper.appendChild(copyUnder);

          msgDiv.appendChild(wrapper);

          const timeSpan = document.createElement("span");
          timeSpan.className = "time";
          timeSpan.textContent = timeStr(ts);
          msgDiv.appendChild(timeSpan);

          chatMessages.appendChild(msgDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          // store (RAM only)
          if(currentChat){
            currentChat.messages.push({ role, content:String(content??""), t: ts || Date.now() });
            if(role==="user" && currentChat.title==="New chat"){
              currentChat.title = makeTitle(String(content||""));
              renderChatList();
            }
          }
          return msgDiv;
        }

        // Errors -> visible in chat
        window.addEventListener("error", (e) => {
          try { addMessage("system", "âŒ JS Error: " + (e.message || "unknown")); } catch(_) {}
        });
        window.addEventListener("unhandledrejection", (e) => {
          try { addMessage("system", "âŒ Promise Error: " + (e.reason?.message || e.reason || "unknown")); } catch(_) {}
        });

        // Loader
        let blinkTimer = null;
        function showBlink(){
          const el = document.createElement("div");
          el.className = "message system";
          const wrapper = document.createElement("div");
          wrapper.className = "content-wrapper";
          const c = document.createElement("div");
          c.className = "content blink";
          c.textContent = "â€¢";
          wrapper.appendChild(c);
          el.appendChild(wrapper);
          chatMessages.appendChild(el);
          chatMessages.scrollTop = chatMessages.scrollHeight;
          let on = true;
          clearInterval(blinkTimer);
          blinkTimer = setInterval(()=>{ on=!on; c.textContent = on ? "â€¢" : " "; }, 450);
          return el;
        }
        function hideBlink(el){
          clearInterval(blinkTimer); blinkTimer=null;
          if(el && el.parentNode) el.parentNode.removeChild(el);
        }

        // Drawer
        function openDrawer(){
          drawer.classList.add("show");
          drawerBackdrop.classList.add("show");
          renderChatList();
        }
        function closeDrawer(){
          drawer.classList.remove("show");
          drawerBackdrop.classList.remove("show");
        }
        openDrawerBtn.addEventListener("click", openDrawer);
        closeDrawerBtn.addEventListener("click", closeDrawer);
        drawerBackdrop.addEventListener("click", closeDrawer);

        // Chats (RAM only, max 10)
        const chats = [];
        let currentChat = null;

        function makeTitle(text){
          const t = (text||"").trim().replace(/\s+/g," ");
          if(!t) return "New chat";
          return t.length>26 ? t.slice(0,26)+"â€¦" : t;
        }

        function renderChatList(){
          chatListEl.innerHTML = "";
          chats.forEach(c=>{
            const item = document.createElement("div");
            item.className = "chatitem" + ((currentChat && currentChat.id===c.id) ? " active" : "");
            const title = document.createElement("div");
            title.className="title";
            title.textContent=c.title;
            const meta = document.createElement("div");
            meta.className="meta";
            meta.textContent=`Messages: ${c.messages.length}`;
            item.appendChild(title); item.appendChild(meta);
            item.onclick=()=>{ switchToChat(c.id); closeDrawer(); };
            chatListEl.appendChild(item);
          });
        }

        function switchToChat(id){
          const found = chats.find(x=>x.id===id);
          if(!found) return;
          currentChat = found;
          chatMessages.innerHTML = "";
          for(const m of currentChat.messages){
            // rebuild without re-storing
            const msgDiv = document.createElement("div");
            msgDiv.className = `message ${m.role}`;
            const wrapper = document.createElement("div");
            wrapper.className = "content-wrapper";
            const contentDiv = document.createElement("div");
            contentDiv.className = "content";
            contentDiv.textContent = m.content;
            wrapper.appendChild(contentDiv);
            const copyUnder = document.createElement("span");
            copyUnder.className = "copy-under";
            copyUnder.textContent = "copy";
            copyUnder.onclick = function(){ copyText(this, contentDiv.textContent || contentDiv.innerText); };
            wrapper.appendChild(copyUnder);
            msgDiv.appendChild(wrapper);
            const timeSpan = document.createElement("span");
            timeSpan.className = "time";
            timeSpan.textContent = timeStr(m.t);
            msgDiv.appendChild(timeSpan);
            chatMessages.appendChild(msgDiv);
          }
          chatMessages.scrollTop = chatMessages.scrollHeight;
          renderChatList();
        }

        function newChat(){
          if(currentChat && currentChat.messages.length===0){
            chatMessages.innerHTML="";
            addMessage("system","Welcome to the infinite space! âœ¨");
            renderChatList();
            return;
          }
          const id="chat_"+Math.random().toString(16).slice(2)+"_"+Date.now();
          const c={id,title:"New chat",createdAt:Date.now(),messages:[]};
          chats.unshift(c);
          while(chats.length>10) chats.pop();
          currentChat=c;
          chatMessages.innerHTML="";
          addMessage("system","Welcome to the infinite space! âœ¨");
          renderChatList();
        }

        newChatBtn.addEventListener("click", ()=>{ newChat(); closeDrawer(); });

        // Upload (minimal)
        uploadBtn.addEventListener("click", ()=>{ fileInput.value=""; fileInput.click(); });
        fileInput.addEventListener("change", ()=>{
          const f=fileInput.files && fileInput.files[0];
          if(!f) return;
          addMessage("user", `ğŸ“ [File selected] ${f.name}`);
          addMessage("system","âš ï¸ File reading ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ Ø¨Ù‡Ø§Ù„Ù†Ø³Ø®Ø© (ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·).");
        });

        // Provider availability + fallback local responder (SO THE UI ALWAYS WORKS)
        function puterAvailable(){
          return !!(window.puter && puter.ai && typeof puter.ai.chat === "function");
        }

        function looksScientificOrDeep(q){
          const s=String(q||"").toLowerCase();
          const keys=["equation","proof","theorem","physics","quantum","relativity","cosmology","black hole","galaxy",
            "algorithm","complexity","optimize","neural","model","training","bayes","likelihood","dtw",
            "Ù…Ø¹Ø§Ø¯Ù„Ø©","Ø¨Ø±Ù‡Ø§Ù†","Ø§Ø´ØªÙ‚Ø§Ù‚","Ù†Ø¸Ø±ÙŠØ©","ÙÙŠØ²ÙŠØ§Ø¡","ÙƒÙ…","Ù†Ø³Ø¨ÙŠØ©","ÙƒÙˆÙ†","Ø«Ù‚Ø¨","Ù…Ø¬Ø±Ø©","Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©","ØªØ¹Ù‚ÙŠØ¯","ØªØ­Ø³ÙŠÙ†",
            "Ù†Ù…ÙˆØ°Ø¬","ØªØ¯Ø±ÙŠØ¨","Ø¨Ø§ÙŠØ²","Ø§Ø­ØªÙ…Ø§Ù„","dtw","ifm2","aic","bic","lensing","Îº"];
          let hit=0; for(const k of keys) if(s.includes(k)) hit++;
          const long=s.length>=240;
          const multi=/[\n\r]|(\b1\)|\b2\)|\b3\)|â€¢|- )/.test(s);
          return hit>=2 || long || multi;
        }

        async function callProvider(prompt, model, maxTokens, timeoutMs){
          const p = puter.ai.chat(prompt, { model, max_tokens:maxTokens, temperature:0.7 });
          return await Promise.race([
            p,
            new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")), timeoutMs))
          ]);
        }

        async function chatWithAI(userText){
          // Always respond, provider optional
          const deep = looksScientificOrDeep(userText);

          const styleDeep =
`Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø¯Ù‚Ø© ÙˆÙˆØ¶ÙˆØ­ ÙˆØ¨Ø´ÙƒÙ„ ØªÙØµÙŠÙ„ÙŠ ÙˆÙ…Ù†Ø¸Ù….
- Ø¹Ø±Ù‘Ù Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹
- Ø«Ù… Ø§Ø´Ø±Ø­ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©
- Ø«Ù… Ø£Ø¹Ø·Ù Ù…Ø«Ø§Ù„Ø§Ù‹ Ø¥Ù† Ø£Ù…ÙƒÙ†
- Ø«Ù… Ø®Ù„Ø§ØµØ© Ù‚ØµÙŠØ±Ø© ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©.`;
          const styleGeneral = `Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø¥ÙŠØ¬Ø§Ø² ÙˆÙˆØ¶ÙˆØ­.`;

          const prompt = `${userText}\n\nSTYLE:\n${deep ? styleDeep : styleGeneral}`;
          const maxTok = userText.length < 450 ? 650 : 1100;

          if(!puterAvailable()){
            // local fallback so UI never â€œfreezesâ€
            return "âš ï¸ Ø§Ù„Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ø¨ÙŠØ¦Ø©. Ù„ÙƒÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªØ¹Ù…Ù„.\n\nØ§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ØµÙØ­Ø© ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ HTTPS ÙˆØ£Ù† Puter.js Ù…Ø³Ù…ÙˆØ­.";
          }

          const primary = deep ? "deepseek-r1" : "gpt-5-nano";
          const fallback = "deepseek-r1";

          try{
            return await callProvider(prompt, primary, maxTok, 12000);
          }catch{
            try{
              return await callProvider(prompt, primary, Math.max(320, Math.floor(maxTok*0.6)), 8000);
            }catch{
              return await callProvider(prompt, fallback, Math.max(450, Math.floor(maxTok*0.8)), 12000);
            }
          }
        }

        // Send wiring
        let sending=false;
        async function onSend(){
          if(sending) return;
          const text=(userInput.value||"").trim();
          if(!text) return;

          sending=true;
          sendBtn.disabled=true;

          addMessage("user", text);
          userInput.value="";

          const loader = showBlink();
          try{
            const resp = await chatWithAI(text);
            hideBlink(loader);
            addMessage("assistant", resp);
          }catch(err){
            hideBlink(loader);
            addMessage("system","âŒ Error: " + (err?.message || String(err)));
          }finally{
            sending=false;
            sendBtn.disabled=false;
            userInput.focus();
          }
        
