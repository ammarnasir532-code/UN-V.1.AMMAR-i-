<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AMMAR//i\\CADEMY - Cosmic AI</title>

  <!-- Optional: Puter.js provider (UI must work even if this fails) -->
  <script src="https://js.puter.com/v2/"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:#f0ebe1;color:#1e1e2e;
      min-height:100vh;display:flex;justify-content:center;align-items:center;
    }

    .app{
      width:100vw;height:100vh;
      background:rgba(255,255,255,.85);
      backdrop-filter:blur(10px);
      display:flex;flex-direction:column;
      overflow:hidden;
    }

    .topbar{
      height:44px;
      display:flex;align-items:center;justify-content:space-between;
      padding:6px 10px;
      border-bottom:1px solid rgba(212,175,55,.2);
      user-select:none;flex-shrink:0;
    }

    .hamburger{
      width:38px;height:38px;border-radius:12px;
      border:2px solid rgba(212,175,55,.55);
      background:rgba(255,255,255,.92);
      box-shadow:0 4px 10px rgba(212,175,55,.14);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      transition:.2s;
    }
    .hamburger:hover{background:rgba(212,175,55,.12);transform:translateY(-1px)}
    .hamburger .lines{width:16px;height:12px;display:flex;flex-direction:column;justify-content:space-between}
    .hamburger .lines span{height:2px;border-radius:2px;background:#1e1e2e;opacity:.85}

    .brand{
      font-weight:800;color:#D4AF37;font-size:.95rem;letter-spacing:.4px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      text-align:center;flex:1;
    }
    .spacer{width:38px;height:38px}

    .chat-container{display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden}
    .chat-messages{
      flex:1;overflow-y:auto;padding:15px;min-height:0;
      box-shadow:inset 0 0 20px rgba(255,255,255,.6),0 4px 15px rgba(0,0,0,.05);
      background:rgba(255,255,255,.3);
      border-radius:20px 20px 0 0;
      margin:10px 10px 0 10px;
    }

    .message{margin-bottom:10px;display:flex;flex-direction:column}
    .message.user{align-items:flex-end}
    .message.assistant{align-items:flex-start}
    .message.system{align-items:center}

    .message .content-wrapper{display:flex;flex-direction:column;align-items:flex-start;max-width:80%}
    .message.user .content-wrapper{align-items:flex-end}

    .message .content{
      padding:6px 12px;border-radius:15px;color:#1e1e2e;
      font-size:0.9em;line-height:1.35;
      box-shadow:0 2px 8px rgba(255,255,255,.5),0 2px 5px rgba(0,0,0,.05);
      border:1px solid rgba(255,215,0,.2);
      word-break:break-word;white-space:pre-wrap;
      background:rgba(255,255,240,.9);
    }
    .message.user .content{background:rgba(255,255,240,.7)}
    .message.system .content{background:rgba(249,226,175,.9)}

    .copy-under{
      background:rgba(255,255,255,.5);
      border:none;border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,.1);
      cursor:pointer;font-size:.7rem;
      padding:2px 8px;margin-top:4px;color:#333;
      transition:.2s;display:inline-block;user-select:none;
    }
    .copy-under:hover{background:rgba(255,255,255,.8);box-shadow:0 4px 8px rgba(0,0,0,.15)}
    .copy-under.copied{background:#4CAF50;color:#fff;box-shadow:none}

    .message .time{font-size:.55em;color:#5a5a7a;margin-top:3px;margin-left:5px}

    .input-frame{
      margin:0 10px 10px 10px;height:4.2cm;
      background:rgba(255,255,255,.6);
      border:1px solid rgba(255,215,0,.3);
      border-radius:20px;backdrop-filter:blur(5px);
      padding:6px 10px;display:flex;flex-direction:column;
      justify-content:space-between;
      box-shadow:0 8px 20px rgba(255,255,255,.3),0 2px 5px rgba(0,0,0,.05);
      flex-shrink:0;
    }
    .input-row{display:flex;align-items:center;gap:6px}
    .input-row textarea{
      flex:1;padding:8px 12px;border-radius:20px;
      border:2px solid rgba(212,175,55,.6);
      background:#fff;color:#1e1e2e;font-size:.9em;
      resize:none;font-family:inherit;
      box-shadow:inset 0 2px 5px rgba(0,0,0,.03),0 2px 5px rgba(255,215,0,.1);
      height:1.9cm;min-height:1.9cm;
      outline:none;
    }
    .circle-send{
      width:38px;height:38px;border-radius:50%;
      background:#fff;border:2px solid #D4AF37;
      box-shadow:0 4px 10px rgba(212,175,55,.2);
      display:flex;align-items:center;justify-content:center;
      font-size:1.8rem;cursor:pointer;transition:.2s;color:#D4AF37;
      flex-shrink:0;line-height:1;user-select:none;
    }
    .circle-send:hover{background:rgba(212,175,55,.1);transform:scale(1.05)}

    .bottom-row{display:flex;align-items:center;justify-content:flex-start;padding:0 6px 2px 6px}
    .icon-btn{
      background:none;border:none;
      font-size:1.15rem;
      cursor:pointer;color:#2d2d3a;
      transition:.2s;padding:0 3px;user-select:none;
    }
    .icon-btn:hover{color:#D4AF37}

    /* Drawer */
    .drawer-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.22);
      display:none;z-index:50;
    }
    .drawer-backdrop.show{display:block}
    .drawer{
      position:fixed;top:0;left:0;height:100vh;width:280px;
      background:rgba(255,255,255,.93);
      backdrop-filter:blur(12px);
      border-right:1px solid rgba(212,175,55,.22);
      box-shadow:12px 0 40px rgba(0,0,0,.12);
      transform:translateX(-100%);
      transition:.22s;
      z-index:60;
      display:flex;flex-direction:column;
    }
    .drawer.show{transform:translateX(0)}
    .drawer-head{
      padding:10px 10px 8px 10px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid rgba(212,175,55,.2);
      user-select:none;
    }
    .drawer-title{font-weight:800;font-size:.85rem}
    .drawer-close{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(212,175,55,.5);
      background:rgba(255,255,255,.9);
      cursor:pointer;
    }

    .newchat-mini{
      width:44px;height:44px;border-radius:14px;
      border:2px solid #D4AF37;
      background:rgba(255,255,255,.95);
      box-shadow:0 4px 10px rgba(212,175,55,.14);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      font-size:1.4rem;font-weight:900;color:#1e1e2e;
      margin:10px 10px 4px 10px;
      user-select:none;
      transition:.2s;
    }
    .newchat-mini:hover{background:rgba(212,175,55,.12);transform:translateY(-1px)}

    .chatlist{padding:6px 8px 12px 8px;overflow:auto;flex:1}
    .chatitem{
      padding:10px 10px;border-radius:14px;
      border:1px solid rgba(212,175,55,.18);
      background:rgba(255,255,255,.68);
      margin:8px 4px;cursor:pointer;
      transition:.15s;user-select:none;
    }
    .chatitem:hover{background:rgba(212,175,55,.10)}
    .chatitem.active{
      background:rgba(212,175,55,.16);
      border-color:rgba(184,134,11,.35);
    }
    .chatitem .title{font-weight:800;font-size:.8rem}
    .chatitem .meta{font-size:.65rem;color:#5a5a7a;margin-top:2px}

    /* single blinking dot */
    .blink{font-weight:900;letter-spacing:2px}
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <button class="hamburger" id="openDrawer" title="Menu">
        <div class="lines"><span></span><span></span><span></span></div>
      </button>
      <div class="brand">AMMAR//i\\CADEMY</div>
      <div class="spacer"></div>
    </div>

    <div class="chat-container">
      <div class="chat-messages" id="chatMessages"></div>

      <div class="input-frame">
        <div class="input-row">
          <textarea id="userInput" placeholder="Type your message here..." rows="1"></textarea>
          <button class="circle-send" id="sendBtn" type="button">â†‘</button>
        </div>

        <div class="bottom-row">
          <button class="icon-btn" id="uploadBtn" title="Upload">ğŸ“</button>
          <input type="file" id="fileInput" style="display:none" />
        </div>
      </div>
    </div>
  </div>

  <div class="drawer-backdrop" id="drawerBackdrop"></div>
  <aside class="drawer" id="drawer">
    <div class="drawer-head">
      <div class="drawer-title">Chats</div>
      <button class="drawer-close" id="closeDrawer" title="Close">âœ•</button>
    </div>
    <div class="newchat-mini" id="newChatBtn" title="New Chat">+</div>
    <div class="chatlist" id="chatList"></div>
  </aside>

  <script>
    // ---------------- RAM-only chat memory (max 10) ----------------
    const chats = [];
    let currentChatId = null;

    const $ = (id) => document.getElementById(id);

    function newId(){
      return "chat_" + Math.random().toString(16).slice(2) + "_" + Date.now();
    }

    function nowTimeStr(ts){
      try { return new Date(ts || Date.now()).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}); }
      catch { return ""; }
    }

    function titleFrom(text){
      const t = String(text||"").trim().replace(/\s+/g," ");
      if(!t) return "New chat";
      return t.length > 26 ? (t.slice(0,26) + "â€¦") : t;
    }

    function getCurrentChat(){
      return chats.find(c => c.id === currentChatId) || null;
    }

    // ---------------- error visibility ----------------
    function addSystemError(msg){
      try { addMessage("system", "âŒ " + msg); } catch(_) {}
    }
    window.addEventListener("error", (e) => addSystemError(e.message || "JS error"));
    window.addEventListener("unhandledrejection", (e) => {
      const m = (e.reason && e.reason.message) ? e.reason.message : String(e.reason || "Promise error");
      addSystemError(m);
    });

    // ---------------- copy ----------------
    window.copyText = function(element, text){
      navigator.clipboard.writeText(text).then(()=>{
        element.classList.add('copied');
        element.textContent = 'âœ“ copied';
        setTimeout(()=>{ element.classList.remove('copied'); element.textContent='copy'; }, 1200);
      }).catch(()=> alert('Failed to copy text'));
    };

    // ---------------- drawer ----------------
    function openDrawer(){
      $("drawer").classList.add("show");
      $("drawerBackdrop").classList.add("show");
      renderChatList();
    }
    function closeDrawer(){
      $("drawer").classList.remove("show");
      $("drawerBackdrop").classList.remove("show");
    }

    // ---------------- render list/messages ----------------
    function renderChatList(){
      const list = $("chatList");
      list.innerHTML = "";
      chats.forEach(c=>{
        const item = document.createElement("div");
        item.className = "chatitem" + (c.id === currentChatId ? " active" : "");

        const t = document.createElement("div");
        t.className = "title";
        t.textContent = c.title;

        const m = document.createElement("div");
        m.className = "meta";
        m.textContent = `Messages: ${c.messages.length}`;

        item.appendChild(t);
        item.appendChild(m);
        item.onclick = () => { switchChat(c.id); closeDrawer(); };

        list.appendChild(item);
      });
    }

    function renderMessages(){
      const box = $("chatMessages");
      box.innerHTML = "";
      const chat = getCurrentChat();
      if(!chat) return;

      for(const msg of chat.messages){
        const msgDiv = document.createElement("div");
        msgDiv.className = `message ${msg.role}`;

        const wrapper = document.createElement("div");
        wrapper.className = "content-wrapper";

        const contentDiv = document.createElement("div");
        contentDiv.className = "content";
        contentDiv.textContent = msg.content;
        wrapper.appendChild(contentDiv);

        const copyUnder = document.createElement("span");
        copyUnder.className = "copy-under";
        copyUnder.textContent = "copy";
        copyUnder.onclick = function(){ copyText(this, contentDiv.textContent || contentDiv.innerText); };
        wrapper.appendChild(copyUnder);

        msgDiv.appendChild(wrapper);

        const timeSpan = document.createElement("span");
        timeSpan.className = "time";
        timeSpan.textContent = nowTimeStr(msg.t);
        msgDiv.appendChild(timeSpan);

        box.appendChild(msgDiv);
      }
      box.scrollTop = box.scrollHeight;
    }

    // ---------------- add message ----------------
    function addMessage(role, content){
      const chat = getCurrentChat();
      if(!chat) return;

      const msg = { role, content: String(content ?? ""), t: Date.now() };
      chat.messages.push(msg);

      if(role === "user" && chat.title === "New chat"){
        chat.title = titleFrom(content);
        renderChatList();
      }

      const box = $("chatMessages");

      const msgDiv = document.createElement("div");
      msgDiv.className = `message ${role}`;

      const wrapper = document.createElement("div");
      wrapper.className = "content-wrapper";

      const contentDiv = document.createElement("div");
      contentDiv.className = "content";
      contentDiv.textContent = msg.content;
      wrapper.appendChild(contentDiv);

      const copyUnder = document.createElement("span");
      copyUnder.className = "copy-under";
      copyUnder.textContent = "copy";
      copyUnder.onclick = function(){ copyText(this, contentDiv.textContent || contentDiv.innerText); };
      wrapper.appendChild(copyUnder);

      msgDiv.appendChild(wrapper);

      const timeSpan = document.createElement("span");
      timeSpan.className = "time";
      timeSpan.textContent = nowTimeStr(msg.t);
      msgDiv.appendChild(timeSpan);

      box.appendChild(msgDiv);
      box.scrollTop = box.scrollHeight;

      return msgDiv;
    }

    // ---------------- loader dot ----------------
    let blinkTimer = null;
    function showBlink(){
      const box = $("chatMessages");

      const el = document.createElement("div");
      el.className = "message system";

      const wrapper = document.createElement("div");
      wrapper.className = "content-wrapper";

      const c = document.createElement("div");
      c.className = "content blink";
      c.textContent = "â€¢";

      wrapper.appendChild(c);
      el.appendChild(wrapper);
      box.appendChild(el);
      box.scrollTop = box.scrollHeight;

      let on = true;
      clearInterval(blinkTimer);
      blinkTimer = setInterval(()=>{ on=!on; c.textContent = on ? "â€¢" : " "; }, 450);

      return el;
    }
    function hideBlink(el){
      clearInterval(blinkTimer);
      blinkTimer = null;
      if(el && el.parentNode) el.parentNode.removeChild(el);
    }

    // ---------------- provider + retry (2 retries) ----------------
    function puterAvailable(){
      return !!(window.puter && puter.ai && typeof puter.ai.chat === "function");
    }

    function looksDeep(q){
      const s = String(q||"").toLowerCase();
      const keys = [
        "equation","proof","theorem","physics","quantum","relativity","cosmology","black hole","galaxy",
        "algorithm","complexity","optimize","model","training","bayes","likelihood","dtw",
        "Ù…Ø¹Ø§Ø¯Ù„Ø©","Ø¨Ø±Ù‡Ø§Ù†","Ø§Ø´ØªÙ‚Ø§Ù‚","Ù†Ø¸Ø±ÙŠØ©","ÙÙŠØ²ÙŠØ§Ø¡","ÙƒÙ…","Ù†Ø³Ø¨ÙŠØ©","ÙƒÙˆÙ†","Ø«Ù‚Ø¨","Ù…Ø¬Ø±Ø©","Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©","ØªØ¹Ù‚ÙŠØ¯","ØªØ­Ø³ÙŠÙ†",
        "Ù†Ù…ÙˆØ°Ø¬","ØªØ¯Ø±ÙŠØ¨","Ø¨Ø§ÙŠØ²","Ø§Ø­ØªÙ…Ø§Ù„","dtw","ifm2","aic","bic","lensing","Îº"
      ];
      let hit=0;
      for(const k of keys) if(s.includes(k)) hit++;
      return hit >= 2 || s.length >= 240;
    }

    async function callProvider(prompt, model, maxTokens, timeoutMs){
      const p = puter.ai.chat(prompt, {
        model,
        max_tokens: maxTokens,
        temperature: 0.7
      });
      return await Promise.race([
        p,
        new Promise((_, rej) => setTimeout(() => rej(new Error("timeout")), timeoutMs))
      ]);
    }

    async function callWithRetry(prompt, model, maxTokens, timeoutMs, retries = 2){
      let lastErr = null;
      for(let attempt = 0; attempt <= retries; attempt++){
        try{
          const dynTokens = Math.max(240, Math.floor(maxTokens * (attempt === 0 ? 1 : 0.7)));
          const dynTimeout = attempt === 0 ? timeoutMs : Math.max(5000, Math.floor(timeoutMs * 0.75));
          return await callProvider(prompt, model, dynTokens, dynTimeout);
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("timeout");
    }

    function localFallbackAnswer(userText){
      const t = String(userText || "").trim();
      if(!t) return "Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø­ØªÙ‰ Ø£Ø¬Ø§ÙˆØ¨Ùƒ.";

      const lower = t.toLowerCase();

      if (/(code|bug|error|html|css|js|javascript|python|api|github|commit|timeout|console)/i.test(lower) ||
          /Ø¨Ø±Ù…Ø¬Ø©|ÙƒÙˆØ¯|Ø®Ø·Ø£|Ù…Ø´ÙƒÙ„Ø©|Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª|Ø¨Ø§ÙŠØ«ÙˆÙ†|html|css|github|ÙƒÙˆÙ…ÙŠØª|ØªØ§ÙŠÙ… Ø§ÙˆØª|ÙƒÙˆÙ†Ø³ÙˆÙ„/.test(t)) {
        return [
          "Ù…Ø§ ÙƒØ¯Ø±Øª Ø£ÙˆØµÙ„ Ù„Ù„Ù…Ø²ÙˆÙ‘Ø¯ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ ÙÙ‡Ù†Ø§ Ø±Ø¯ Ù…Ø­Ù„ÙŠ Ø³Ø±ÙŠØ¹ ÙŠØ³Ø§Ø¹Ø¯Ùƒ:",
          "",
          "1) Ø§ÙØªØ­ DevTools > Console ÙˆØ´ÙˆÙ Ø£ÙˆÙ„ Error (Ù‡Ùˆ Ø¹Ø§Ø¯Ø© Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©).",
          "2) Ø¬Ø±Ù‘Ø¨ ØªØ­Ø¯ÙŠØ« Ù‚ÙˆÙŠ Ù„Ù„ØµÙØ­Ø© (Incognito Ø£Ùˆ ?v=3).",
          "3) Ø¥Ø°Ø§ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© timeout: Ø¬Ø±Ù‘Ø¨ Ø³Ø¤Ø§Ù„ Ø£Ù‚ØµØ± Ø£Ùˆ Ø¨Ø¯Ù‘Ù„ Ø´Ø¨ÙƒØ©/VPN.",
          "",
          "Ø¥Ø°Ø§ ØªØ±Ø³Ù„ Ù„ÙŠ Ù†Øµ Ø§Ù„Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ù€ Console Ø£Ú¯Ø¯Ø± Ø£Ø­Ø¯Ø¯ Ø§Ù„Ø³Ø¨Ø¨ Ø¨Ø¯Ù‚Ø©."
        ].join("\n");
      }

      if (/(equation|physics|math|proof|theorem|quantum|relativity)/i.test(lower) ||
          /Ù…Ø¹Ø§Ø¯Ù„Ø©|ÙÙŠØ²ÙŠØ§Ø¡|Ø±ÙŠØ§Ø¶ÙŠØ§Øª|Ø¨Ø±Ù‡Ø§Ù†|Ù†Ø¸Ø±ÙŠØ©|ÙƒÙ…|Ù†Ø³Ø¨ÙŠØ©/.test(t)) {
        return [
          "Ø§Ù„Ù…Ø²ÙˆÙ‘Ø¯ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ù…Ø§ Ø±Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø¨Ø³ Ø£Ø¬Ø§ÙˆØ¨Ùƒ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø¸Ù…:",
          "",
          "â€¢ ÙˆØ¶Ù‘Ø­ Ù„ÙŠ: Ø§Ù„Ù…Ø¹Ø·ÙŠØ§Øª + Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ + Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø´ØªÙ‚Ø§Ù‚ Ù„Ùˆ ØªÙØ³ÙŠØ±.",
          "â€¢ Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ù…Ø¹Ø§Ø¯Ù„Ø©/Ù†ØµØŒ Ø§Ù†Ø³Ø®Ù‡Ø§ Ù‡Ù†Ø§ Ø­ØªÙ‰ Ø£Ø±ØªØ¨ Ø§Ù„Ø­Ù„ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©.",
          "",
          "Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ØªØ­ØªØ§Ø¬ Ø£Ø±Ù‚Ø§Ù…/Ù…Ø±Ø§Ø¬Ø¹ Ø­Ø¯ÙŠØ«Ø©ØŒ Ù„Ø§Ø²Ù… Ø§ØªØµØ§Ù„ ÙØ¹Ù‘Ø§Ù„ Ø¨Ø§Ù„Ù…Ø²ÙˆÙ‘Ø¯ Ø£Ùˆ Ù…ØµØ¯Ø± Ø¥Ù†ØªØ±Ù†Øª."
        ].join("\n");
      }

      return [
        "Ø§Ù„Ù…Ø²ÙˆÙ‘Ø¯ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ØªØ£Ø®Ø±/ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ ÙÙ‡Ù†Ø§ Ø±Ø¯ Ù…Ø­Ù„ÙŠ Ø³Ø±ÙŠØ¹:",
        "",
        "â€¢ Ø§Ø´Ø±Ø­ Ù„ÙŠ Ø£ÙƒØ«Ø± Ø´Ù†Ùˆ ØªÙ‚ØµØ¯ Ø¨Ø§Ù„Ø¶Ø¨Ø· (Ù‡Ø¯ÙÙƒ + Ø§Ù„Ù‚ÙŠÙˆØ¯).",
        "â€¢ Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ù…Ø«Ø§Ù„/ØµÙˆØ±Ø©/Ù†ØµØŒ Ø§Ø±ÙØ¹Ù‡ Ø­ØªÙ‰ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø£Ø¯Ù‚."
      ].join("\n");
    }

    async function chatWithAI(userText){
      const deep = looksDeep(userText);

      const styleDeep =
`Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø¯Ù‚Ø© ÙˆÙˆØ¶ÙˆØ­ ÙˆØ¨Ø´ÙƒÙ„ ØªÙØµÙŠÙ„ÙŠ ÙˆÙ…Ù†Ø¸Ù….
- Ø¹Ø±Ù‘Ù Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹
- Ø«Ù… Ø§Ø´Ø±Ø­ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©
- Ø«Ù… Ø£Ø¹Ø·Ù Ù…Ø«Ø§Ù„Ø§Ù‹ Ø¥Ù† Ø£Ù…ÙƒÙ†
- Ø«Ù… Ø®Ù„Ø§ØµØ© Ù‚ØµÙŠØ±Ø© ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©.`;
      const styleGeneral = `Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø¥ÙŠØ¬Ø§Ø² ÙˆÙˆØ¶ÙˆØ­.`;

      const prompt = `${userText}\n\nSTYLE:\n${deep ? styleDeep : styleGeneral}`;
      const maxTok = userText.length < 450 ? 650 : 1100;

      if(!puterAvailable()){
        // throw to trigger local fallback path in onSend
        throw new Error("provider_unavailable");
      }

      const primary = deep ? "deepseek-r1" : "gpt-5-nano";
      const fallback = "deepseek-r1";

      try{
        return await callWithRetry(prompt, primary, maxTok, 12000, 2);
      }catch{
        return await callWithRetry(prompt, fallback, Math.max(450, Math.floor(maxTok*0.8)), 12000, 2);
      }
    }

    // ---------------- chats ----------------
    function createChat(){
      const c = { id: newId(), title: "New chat", createdAt: Date.now(), messages: [] };
      chats.unshift(c);
      while(chats.length > 10) chats.pop();
      currentChatId = c.id;
      renderMessages();
      renderChatList();
      addMessage("system", "Welcome to the infinite space! âœ¨");
    }

    function switchChat(id){
      currentChatId = id;
      renderMessages();
      renderChatList();
    }

    // ---------------- send ----------------
    let sending = false;

    async function onSend(){
      if(sending) return;

      const input = $("userInput");
      const sendBtn = $("sendBtn");

      const text = (input.value || "").trim();
      if(!text) return;

      sending = true;
      sendBtn.disabled = true;

      addMessage("user", text);
      input.value = "";

      const loader = showBlink();
      try{
        const resp = await chatWithAI(text);
        hideBlink(loader);
        addMessage("assistant", resp);
      }catch(err){
        hideBlink(loader);
        const m = (err?.message || String(err) || "").toLowerCase();

        if(m.includes("timeout")){
          addMessag
