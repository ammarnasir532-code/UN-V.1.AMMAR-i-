<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AMMAR//i\\CADEMY - Cosmic AI</title>

  <!-- Puter.js (for AI) -->
  <script src="https://js.puter.com/v2/"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>

  <!-- Mammoth (DOCX) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js"></script>

  <!-- Tesseract.js (OCR) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.5/tesseract.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:#f0ebe1;color:#1e1e2e;
      min-height:100vh;display:flex;justify-content:center;align-items:center;
      padding:0;
    }
    .app{width:100vw;height:100vh;display:flex;background:rgba(255,255,255,.85);backdrop-filter:blur(10px)}
    /* Sidebar (only New Chat icon) */
    .sidebar{
      width:64px;
      border-right:1px solid rgba(212,175,55,.22);
      background:rgba(255,255,255,.65);
      display:flex;flex-direction:column;align-items:center;
      padding:10px 6px;gap:10px;
    }
    .newchat-icon{
      width:44px;height:44px;border-radius:14px;
      border:2px solid #D4AF37;
      background:rgba(255,255,255,.9);
      box-shadow:0 4px 8px rgba(212,175,55,.12);
      cursor:pointer;transition:.2s;user-select:none;
      display:flex;align-items:center;justify-content:center;
      font-size:1.2rem;color:#1e1e2e;
    }
    .newchat-icon:hover{background:rgba(212,175,55,.12);transform:translateY(-1px)}
    .brand-mini{
      margin-top:6px;text-align:center;font-size:.55rem;line-height:1.1;color:#5a5a7a;
      user-select:none;
    }
    /* Main */
    .main{flex:1;display:flex;flex-direction:column;min-width:0}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:6px 10px;border-bottom:1px solid rgba(212,175,55,.2);
    }
    .topbar .hint{font-size:.75rem;color:#5a5a7a;font-weight:700}
    .model-selector select{
      padding:3px 8px;border-radius:20px;border:1px solid #D4AF37;
      background:#fff;color:#1e1e2e;font-size:.7rem;cursor:pointer;
    }
    .chat-container{display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden}
    .chat-messages{
      flex:1;overflow-y:auto;padding:15px;min-height:0;
      box-shadow:inset 0 0 20px rgba(255,255,255,.6),0 4px 15px rgba(0,0,0,.05);
      background:rgba(255,255,255,.3);
      border-radius:20px 20px 0 0;
      margin:8px 10px 0 10px;
    }
    .message{margin-bottom:10px;display:flex;flex-direction:column;position:relative}
    .message.user{align-items:flex-end}
    .message.assistant{align-items:flex-start}
    .message.system{align-items:center}
    .message .content-wrapper{display:flex;flex-direction:column;align-items:flex-start;max-width:80%}
    .message.user .content-wrapper{align-items:flex-end}
    .message .content{
      padding:6px 12px;border-radius:15px;color:#1e1e2e;
      font-size:0.85em;line-height:1.3;
      box-shadow:0 2px 8px rgba(255,255,255,.5),0 2px 5px rgba(0,0,0,.05);
      border:1px solid rgba(255,215,0,.2);
      word-break:break-word;white-space:pre-wrap;
    }
    .message.user .content{background:rgba(255,255,240,.7)}
    .message.assistant .content{background:rgba(255,255,240,.9)}
    .message.system .content{background:rgba(249,226,175,.9)}
    .copy-under{
      background:rgba(255,255,255,.5);
      border:none;border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,.1);
      cursor:pointer;font-size:.7rem;
      padding:2px 8px;margin-top:4px;color:#333;
      transition:.2s;display:inline-block;user-select:none;
    }
    .copy-under:hover{background:rgba(255,255,255,.8);box-shadow:0 4px 8px rgba(0,0,0,.15)}
    .copy-under.copied{background:#4CAF50;color:#fff;box-shadow:none}
    .message .time{font-size:.55em;color:#5a5a7a;margin-top:3px;margin-left:5px}

    .input-frame{
      margin:0 10px 10px 10px;height:4cm;
      background:rgba(255,255,255,.6);
      border:1px solid rgba(255,215,0,.3);
      border-radius:20px;backdrop-filter:blur(5px);
      padding:6px 10px;display:flex;flex-direction:column;
      justify-content:space-between;
      box-shadow:0 8px 20px rgba(255,255,255,.3),0 2px 5px rgba(0,0,0,.05);
    }
    .input-row{display:flex;align-items:center;gap:5px}
    .input-row textarea{
      flex:1;padding:6px 10px;border-radius:20px;
      border:2px solid rgba(212,175,55,.6);
      background:#fff;color:#1e1e2e;font-size:.85em;
      resize:none;font-family:inherit;
      box-shadow:inset 0 2px 5px rgba(0,0,0,.03),0 2px 5px rgba(255,215,0,.1);
      height:1.8cm;min-height:1.8cm;
    }
    .circle-send{
      width:38px;height:38px;border-radius:50%;
      background:#fff;border:2px solid #D4AF37;
      box-shadow:0 4px 10px rgba(212,175,55,.2);
      display:flex;align-items:center;justify-content:center;
      font-size:1.8rem;cursor:pointer;transition:.2s;color:#D4AF37;
      flex-shrink:0;line-height:1;user-select:none;
    }
    .circle-send:hover{background:rgba(212,175,55,.1);transform:scale(1.05)}
    .compact-row{display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap}
    .upload-icon-small{
      background:none;border:none;font-size:1.1rem;cursor:pointer;color:#2d2d3a;
      transition:.2s;padding:0 3px;user-select:none;
    }
    .upload-icon-small:hover{color:#D4AF37}
    .image-result{margin:0 10px 10px 10px;text-align:center}
    .image-result img{
      max-width:200px;max-height:200px;border-radius:15px;
      box-shadow:0 5px 15px rgba(0,0,0,.2);
      border:2px solid #D4AF37;cursor:pointer;transition:.2s;
    }
    .image-result img:hover{transform:scale(1.02);box-shadow:0 8px 20px rgba(212,175,55,.3)}
    .download-link{
      display:inline-block;margin-top:5px;padding:4px 12px;background:#D4AF37;color:#fff;
      border-radius:20px;text-decoration:none;font-size:.7rem;font-weight:bold;
    }
    .download-link:hover{background:#b8860b}
    @media (max-width: 720px){ .sidebar{width:54px} }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="newchat-icon" id="newChatBtn" title="New chat">ï¼‹</div>
      <div class="brand-mini">AMMAR<br/>2026</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="hint" id="deepHint">Auto DeepThink: OFF</div>
        <div class="model-selector">
          <select id="modelSelect">
            <option value="gpt-5-nano">GPT-5 Nano</option>
            <option value="claude-opus-4">Claude Opus 4</option>
            <option value="gemini-2.0-pro">Gemini 2.0 Pro</option>
            <option value="deepseek-r1" selected>DeepSeek R1</option>
          </select>
        </div>
      </div>

      <div class="chat-container">
        <div class="chat-messages" id="chatMessages"></div>

        <div class="input-frame">
          <div class="input-row">
            <textarea id="userInput" placeholder="Type your message here..." rows="1"></textarea>
            <button class="circle-send" id="sendBtn">â†‘</button>
          </div>

          <div class="compact-row">
            <button class="upload-icon-small" id="uploadBtn" title="Upload file (Image/PDF/DOCX/XLSX)">ðŸ“Ž</button>
          </div>

          <input type="file" id="fileInput" accept="image/*,.pdf,.docx,.xlsx" style="display:none;">
        </div>

        <div class="image-result" id="imageResult"></div>
      </div>
    </main>
  </div>

  <script>
    // ======== IMPORTANT: No device storage ========
    // - NO localStorage
    // - NO IndexedDB
    // Everything resets on refresh/close.

    // pdf.js worker
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";
    }

    // DOM
    const chatMessages = document.getElementById('chatMessages');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    const modelSelect = document.getElementById('modelSelect');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const imageResult = document.getElementById('imageResult');
    const newChatBtn = document.getElementById('newChatBtn');
    const deepHint = document.getElementById('deepHint');
    const uploadBtnEl = document.getElementById('uploadBtn');

    // RAM cache
    const responseCache = new Map();

    // ======== Copy ========
    window.copyText = function(element, text){
      navigator.clipboard.writeText(text).then(()=>{
        element.classList.add('copied');
        element.textContent = 'âœ“ copied';
        setTimeout(()=>{
          element.classList.remove('copied');
          element.textContent = 'copy';
        }, 2000);
      }).catch(()=> alert('Failed to copy text'));
    };

    // ======== Rendering ========
    function escapeHTML(str){
      return String(str||"")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function sanitizeModelThinking(text){
      return String(text||"")
        .replace(/deepseek\s*r1\s*[:\-]?\s*thinking/gi, "thinking")
        .replace(/\bdeepseek\s*r1\b/gi, "");
    }

    function renderContentToHTML(text){
      const s = sanitizeModelThinking(text);
      const parts = s.split(/```/);
      let out = "";
      for(let i=0;i<parts.length;i++){
        if(i % 2 === 0){
          out += escapeHTML(parts[i]).replace(/\n/g,"<br>");
        } else {
          const code = escapeHTML(parts[i].replace(/^\w+\n/, ""));
          out += `<pre style="white-space:pre-wrap;margin:8px 0;padding:8px;border-radius:12px;border:1px solid rgba(212,175,55,0.35);background:rgba(255,255,255,0.65);font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:0.8em;">${code}</pre>`;
        }
      }
      out = out.replace(/`([^`]+)`/g, (m,g1)=>`<code style="padding:1px 6px;border-radius:8px;border:1px solid rgba(212,175,55,0.35);background:rgba(255,255,255,0.6);">${escapeHTML(g1)}</code>`);
      return out;
    }

    function addMessage(role, content, isHtml=false){
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${role}`;

      const wrapper = document.createElement('div');
      wrapper.className = 'content-wrapper';

      const contentDiv = document.createElement('div');
      contentDiv.className = 'content';

      if(isHtml) contentDiv.innerHTML = content;
      else contentDiv.textContent = content;

      wrapper.appendChild(contentDiv);

      const copyUnder = document.createElement('span');
      copyUnder.className = 'copy-under';
      copyUnder.textContent = 'copy';
      copyUnder.onclick = function(){ copyText(this, contentDiv.textContent || contentDiv.innerText); };
      wrapper.appendChild(copyUnder);

      msgDiv.appendChild(wrapper);

      const timeSpan = document.createElement('span');
      timeSpan.className = 'time';
      const now = new Date();
      timeSpan.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      msgDiv.appendChild(timeSpan);

      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      return msgDiv;
    }

    // ======== Blinking dot loader ========
    let blinkTimer = null;
    let blinkEl = null;

    function showBlinkLoader(){
      const div = document.createElement('div');
      div.className = 'message system';

      const wrapper = document.createElement('div');
      wrapper.className = 'content-wrapper';

      const content = document.createElement('div');
      content.className = 'content';
      content.textContent = "â€¢";

      wrapper.appendChild(content);
      div.appendChild(wrapper);

      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      blinkEl = content;
      let on = true;

      clearInterval(blinkTimer);
      blinkTimer = setInterval(()=>{
        if(!blinkEl) return;
        on = !on;
        blinkEl.textContent = on ? "â€¢" : " ";
      }, 450);

      return div;
    }

    function hideBlinkLoader(loader){
      clearInterval(blinkTimer);
      blinkTimer = null;
      blinkEl = null;
      if(loader && loader.parentNode) loader.parentNode.removeChild(loader);
    }

    // ======== Auto DeepThink detection ========
    function looksScientificOrDeep(q){
      const s = String(q||"").toLowerCase();

      // Heuristic keywords (English + Arabic)
      const keys = [
        "equation","derivation","proof","theorem","physics","quantum","relativity","cosmology","black hole","galaxy",
        "algorithm","complexity","optimize","neural","model","training","gradient","bayes","likelihood","dtw",
        "Ù…Ø¹Ø§Ø¯Ù„Ø©","Ø¨Ø±Ù‡Ø§Ù†","Ø§Ø´ØªÙ‚Ø§Ù‚","Ù†Ø¸Ø±ÙŠØ©","ÙÙŠØ²ÙŠØ§Ø¡","ÙƒÙ…","Ù†Ø³Ø¨ÙŠØ©","ÙƒÙˆÙ†","Ø«Ù‚Ø¨","Ù…Ø¬Ø±Ø©","Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©","ØªØ¹Ù‚ÙŠØ¯","ØªØ­Ø³ÙŠÙ†",
        "Ù†Ù…ÙˆØ°Ø¬","ØªØ¯Ø±ÙŠØ¨","Ø¨Ø§ÙŠØ²","Ø§Ø­ØªÙ…Ø§Ù„","Ø¯Ù„ÙŠÙ„","dtw","ifm2","aic","bic","fÏƒ8","lensing","Îº","Ù†Ù…Ùˆ"
      ];
      let hit = 0;
      for(const k of keys) if(s.includes(k)) hit++;

      // Also: longer / multi-part questions
      const long = s.length >= 280;
      const multi = /[\n\r]|(\b1\)|\b2\)|\b3\)|â€¢|- )/.test(s);

      return hit >= 2 || long || multi;
    }

    function setAutoDeepThinkUI(on){
      deepHint.textContent = on ? "Auto DeepThink: ON" : "Auto DeepThink: OFF";
    }

    // ======== Wikipedia helpers (only used when question is deep/scientific) ========
    function normalizeForKeywords(s){
      return String(s||"")
        .toLowerCase()
        .replace(/[^\p{L}\p{N}\s]/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    }
    function extractKeywords(text, max=6){
      const t = normalizeForKeywords(text);
      if(!t) return [];
      const stop = new Set(["the","and","for","with","this","that","from","into","about","what","why","how","when","where","which",
                            "ÙÙŠ","Ù…Ù†","Ø¹Ù„Ù‰","Ø§Ù„Ù‰","Ø¥Ù„Ù‰","Ø¹Ù†","Ù…Ø§","Ù…Ø§Ø°Ø§","Ù„Ù…Ø§Ø°Ø§","ÙƒÙŠÙ","Ù…ØªÙ‰","Ø£ÙŠÙ†","Ø§ÙŠ","Ø£ÙŠ","Ù…Ø¹","Ù‡Ø°Ø§","Ù‡Ø°Ù‡","Ø°Ù„Ùƒ","ØªÙ„Ùƒ"]);
      const words = t.split(" ").filter(w => w.length >= 4 && !stop.has(w));
      const freq = new Map();
      for(const w of words) freq.set(w, (freq.get(w)||0)+1);
      return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,max).map(x=>x[0]);
    }
    async function wikiSummary(title){
      const url = "https://en.wikipedia.org/api/rest_v1/page/summary/" + encodeURIComponent(title);
      const r = await fetch(url, { headers:{accept:"application/json"} });
      if(!r.ok) throw new Error("Wikipedia failed");
      const j = await r.json();
      const extract = (j?.extract || "").replace(/\s+/g," ").trim();
      const pageUrl = j?.content_urls?.desktop?.page || ("https://en.wikipedia.org/wiki/" + encodeURIComponent(title.replace(/ /g,"_")));
      return { title, extract, url: pageUrl };
    }
    async function wikiSearch(query, limit=3){
      const url = "https://en.wikipedia.org/w/api.php?origin=*&action=query&list=search&format=json&srsearch=" + encodeURIComponent(query);
      const r = await fetch(url);
      if(!r.ok) throw new Error("Wikipedia search failed");
      const j = await r.json();
      return (j?.query?.search || []).slice(0, limit).map(x => x.title);
    }
    async function fetchWikiPack(question){
      const keys = extractKeywords(question, 5);
      if(keys.length === 0) return [];
      const titles = [];
      try{
        const r1 = await wikiSearch(keys[0], 2);
        for(const t of r1) titles.push(t);
      }catch(_){}
      if(keys[1]){
        try{
          const r2 = await wikiSearch(keys[1], 1);
          for(const t of r2) titles.push(t);
        }catch(_){}
      }
      const uniq = [...new Set(titles)].slice(0,2);
      const out = [];
      for(const t of uniq){
        try{
          const s = await wikiSummary(t);
          if(s.extract) out.push(s);
        }catch(_){}
      }
      return out;
    }
    function formatWikiBlock(pages){
      if(!pages || pages.length === 0) return "";
      const facts = pages
        .filter(p => p.extract)
        .map(p => `â€¢ ${p.title}: ${p.extract.slice(0, 420)}\n  Source: ${p.url}`)
        .join("\n\n");
      return `\n\nÙ…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø®ØªØµØ±Ø© Ù…Ù† ÙˆÙŠÙƒÙŠØ¨ÙŠØ¯ÙŠØ§:\n${facts}\n`;
    }

    // ======== AI Call (timeout + retry + dynamic tokens + auto deepthink) ========
    async function puterChatText(message, opts){
      return await puter.ai.chat(message, opts);
    }

    async function chatWithAI(message){
      const cacheKey = modelSelect.value + ":" + message;
      if(responseCache.has(cacheKey)) return responseCache.get(cacheKey);

      const len = String(message||"").length;
      const baseMaxTok = (len < 450) ? 650 : 1100;

      const baseOpts = { model: modelSelect.value, max_tokens: baseMaxTok };
      if(modelSelect.value !== "deepseek-r1") baseOpts.temperature = 0.7;

      const attempt = async (timeoutMs, optsOverride={}) => {
        const opts = { ...baseOpts, ...optsOverride };
        const p = puterChatText(message, opts);
        return await Promise.race([
          p,
          new Promise((_, rej)=> setTimeout(()=> rej(new Error("timeout")), timeoutMs))
        ]);
      };

      try{
        const r = await attempt(12000);
        responseCache.set(cacheKey, r);
        if(responseCache.size > 120){
          const firstKey = responseCache.keys().next().value;
          responseCache.delete(firstKey);
        }
        return r;
      }catch(e1){
        // quick retry with lower tokens
        try{
          const r2 = await attempt(8000, { max_tokens: Math.max(320, Math.floor(baseMaxTok * 0.6)) });
          return r2;
        }catch(e2){
          // fallback to deepseek-r1
          const prev = modelSelect.value;
          modelSelect.value = "deepseek-r1";
          try{
            const r3 = await attempt(12000, { model: "deepseek-r1", max_tokens: Math.max(450, Math.floor(baseMaxTok * 0.8)) });
            return r3;
          } finally {
            modelSelect.value = prev;
          }
        }
      }
    }

    // ======== Image generation (Pollinations) ========
    async function generateImage(prompt){
      const imgUrl = `https://pollinations.ai/p/${encodeURIComponent(prompt)}`;
      imageResult.innerHTML = `
        <img src="${imgUrl}" alt="${escapeHTML(prompt)}" onclick="window.open('${imgUrl}')">
        <br>
        <a href="${imgUrl}" download="${prompt.replace(/\s+/g,'_')}.png" class="download-link">ðŸ“¥ Download Image</a>
      `;
      return imgUrl;
    }
    async function handleImageRequest(text){
      const enhanced = await chatWithAI("Improve this prompt for an image generation: " + text);
      return generateImage(String(enhanced || text));
    }

    // ======== File reading ========
    function fileExt(name){
      const n = (name||"").toLowerCase();
      const i = n.lastIndexOf(".");
      return i >= 0 ? n.slice(i+1) : "";
    }

    async function readPDFText(file){
      if(!window.pdfjsLib) throw new Error("PDF.js not loaded");
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

      const maxPages = Math.min(pdf.numPages, 12);
      let text = "";
      for(let p=1; p<=maxPages; p++){
        const page = await pdf.getPage(p);
        const c = await page.getTextContent();
        const pageText = c.items.map(it => it.str).join(" ").replace(/\s+/g," ").trim();
        if(pageText) text += `\n\n[Page ${p}] ${pageText}`;
        if(text.length > 22000) break;
      }
      return text.trim();
    }

    async function readDOCX(file){
      if(!window.ma
