<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AMMAR//i\\CADEMY - Cosmic AI</title>

  <!-- Puter.js -->
  <script src="https://js.puter.com/v2/"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:#f0ebe1;color:#1e1e2e;
      min-height:100vh;display:flex;justify-content:center;align-items:center;
      padding:0;
    }

    .app{
      width:100vw;height:100vh;
      display:flex;flex-direction:column;
      background:rgba(255,255,255,.85);
      backdrop-filter:blur(10px);
      overflow:hidden;
    }

    /* Top bar */
    .topbar{
      height:44px;
      display:flex;align-items:center;justify-content:space-between;
      padding:6px 10px;
      border-bottom:1px solid rgba(212,175,55,.2);
      flex-shrink:0;
    }
    .left-top{
      display:flex;align-items:center;gap:10px;
      min-width:0;
    }
    .hamburger{
      width:36px;height:36px;border-radius:12px;
      border:2px solid rgba(212,175,55,.6);
      background:rgba(255,255,255,.9);
      box-shadow:0 4px 8px rgba(212,175,55,.12);
      cursor:pointer;user-select:none;
      display:flex;align-items:center;justify-content:center;
      transition:.2s;
    }
    .hamburger:hover{background:rgba(212,175,55,.12);transform:translateY(-1px)}
    .hamburger .lines{
      width:16px;height:12px;display:flex;flex-direction:column;justify-content:space-between;
    }
    .hamburger .lines span{
      height:2px;border-radius:2px;background:#1e1e2e;opacity:.85;
    }

    .brand{
      font-weight:800;
      color:#D4AF37;
      font-size:.9rem;
      letter-spacing:.4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .model-selector select{
      padding:3px 8px;border-radius:20px;border:1px solid #D4AF37;
      background:#fff;color:#1e1e2e;font-size:.7rem;cursor:pointer;
    }

    /* Drawer */
    .drawer-backdrop{
      position:fixed;inset:0;
      background:rgba(0,0,0,.2);
      display:none;
      z-index:50;
    }
    .drawer-backdrop.show{display:block}

    .drawer{
      position:fixed;top:0;left:0;height:100vh;width:290px;
      background:rgba(255,255,255,.92);
      backdrop-filter:blur(12px);
      border-right:1px solid rgba(212,175,55,.22);
      box-shadow: 12px 0 40px rgba(0,0,0,.12);
      transform:translateX(-100%);
      transition:.22s;
      z-index:60;
      display:flex;flex-direction:column;
    }
    .drawer.show{transform:translateX(0)}
    .drawer-head{
      padding:12px 12px 10px 12px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid rgba(212,175,55,.2);
    }
    .drawer-title{
      font-weight:800;color:#1e1e2e;font-size:.85rem;
    }
    .drawer-close{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(212,175,55,.5);
      background:rgba(255,255,255,.9);
      cursor:pointer;
    }

    .newchat-btn{
      margin:12px;
      border-radius:16px;
      border:2px solid #D4AF37;
      background:rgba(255,255,255,.95);
      box-shadow:0 4px 8px rgba(212,175,55,.12);
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
      display:flex;align-items:center;justify-content:center;
      gap:8px;
      transition:.2s;
      user-select:none;
    }
    .newchat-btn:hover{background:rgba(212,175,55,.12);transform:translateY(-1px)}

    .chatlist{
      padding:0 8px 12px 8px;
      overflow:auto;
      flex:1;
    }
    .chatitem{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(212,175,55,.18);
      background:rgba(255,255,255,.65);
      margin:8px 4px;
      cursor:pointer;
      transition:.15s;
      user-select:none;
    }
    .chatitem:hover{background:rgba(212,175,55,.10)}
    .chatitem.active{
      background:rgba(212,175,55,.16);
      border-color:rgba(184,134,11,.35);
    }
    .chatitem .title{font-weight:800;font-size:.8rem;color:#1e1e2e}
    .chatitem .meta{font-size:.65rem;color:#5a5a7a;margin-top:2px}

    /* Chat */
    .chat-container{display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden}
    .chat-messages{
      flex:1;overflow-y:auto;padding:15px;min-height:0;
      box-shadow:inset 0 0 20px rgba(255,255,255,.6),0 4px 15px rgba(0,0,0,.05);
      background:rgba(255,255,255,.3);
      border-radius:20px 20px 0 0;
      margin:10px 10px 0 10px;
    }

    .message{margin-bottom:10px;display:flex;flex-direction:column;position:relative}
    .message.user{align-items:flex-end}
    .message.assistant{align-items:flex-start}
    .message.system{align-items:center}
    .message .content-wrapper{display:flex;flex-direction:column;align-items:flex-start;max-width:80%}
    .message.user .content-wrapper{align-items:flex-end}
    .message .content{
      padding:6px 12px;border-radius:15px;color:#1e1e2e;
      font-size:0.85em;line-height:1.3;
      box-shadow:0 2px 8px rgba(255,255,255,.5),0 2px 5px rgba(0,0,0,.05);
      border:1px solid rgba(255,215,0,.2);
      word-break:break-word;white-space:pre-wrap;
    }
    .message.user .content{background:rgba(255,255,240,.7)}
    .message.assistant .content{background:rgba(255,255,240,.9)}
    .message.system .content{background:rgba(249,226,175,.9)}

    .copy-under{
      background:rgba(255,255,255,.5);
      border:none;border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,.1);
      cursor:pointer;font-size:.7rem;
      padding:2px 8px;margin-top:4px;color:#333;
      transition:.2s;display:inline-block;user-select:none;
    }
    .copy-under:hover{background:rgba(255,255,255,.8);box-shadow:0 4px 8px rgba(0,0,0,.15)}
    .copy-under.copied{background:#4CAF50;color:#fff;box-shadow:none}
    .message .time{font-size:.55em;color:#5a5a7a;margin-top:3px;margin-left:5px}

    /* Input */
    .input-frame{
      margin:0 10px 10px 10px;height:4.2cm;
      background:rgba(255,255,255,.6);
      border:1px solid rgba(255,215,0,.3);
      border-radius:20px;backdrop-filter:blur(5px);
      padding:6px 10px;display:flex;flex-direction:column;
      justify-content:space-between;
      box-shadow:0 8px 20px rgba(255,255,255,.3),0 2px 5px rgba(0,0,0,.05);
      flex-shrink:0;
    }
    .input-row{display:flex;align-items:center;gap:5px}
    .input-row textarea{
      flex:1;padding:6px 10px;border-radius:20px;
      border:2px solid rgba(212,175,55,.6);
      background:#fff;color:#1e1e2e;font-size:.85em;
      resize:none;font-family:inherit;
      box-shadow:inset 0 2px 5px rgba(0,0,0,.03),0 2px 5px rgba(255,215,0,.1);
      height:1.8cm;min-height:1.8cm;
    }
    .circle-send{
      width:38px;height:38px;border-radius:50%;
      background:#fff;border:2px solid #D4AF37;
      box-shadow:0 4px 10px rgba(212,175,55,.2);
      display:flex;align-items:center;justify-content:center;
      font-size:1.8rem;cursor:pointer;transition:.2s;color:#D4AF37;
      flex-shrink:0;line-height:1;user-select:none;
    }
    .circle-send:hover{background:rgba(212,175,55,.1);transform:scale(1.05)}

    /* Bottom controls (clip + deep think + provider) */
    .bottom-row{
      display:flex;align-items:center;justify-content:flex-start;
      gap:10px;padding:0 6px 2px 6px;
      color:#2d2d3a;
      flex-wrap:wrap;
    }
    .icon-btn{
      background:none;border:none;
      font-size:1.1rem;
      cursor:pointer;color:#2d2d3a;
      transition:.2s;padding:0 3px;user-select:none;
    }
    .icon-btn:hover{color:#D4AF37}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(212,175,55,.35);
      background:rgba(255,255,255,.65);
      padding:4px 10px;border-radius:999px;
      font-size:.72rem;font-weight:800;
      user-select:none;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;background:#999;
      display:inline-block;
    }
    .dot.on{background:#22c55e} /* green */
    .dot.off{background:#9ca3af} /* gray */

    /* Blink loader message */
    .blink{font-weight:800;letter-spacing:2px}

  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="left-top">
        <button class="hamburger" id="openDrawer" title="Menu">
          <div class="lines"><span></span><span></span><span></span></div>
        </button>
        <div class="brand">AMMAR//i\\CADEMY</div>
      </div>

      <div class="model-selector">
        <select id="modelSelect">
          <option value="gpt-5-nano">GPT-5 Nano</option>
          <option value="claude-opus-4">Claude Opus 4</option>
          <option value="gemini-2.0-pro">Gemini 2.0 Pro</option>
          <option value="deepseek-r1" selected>DeepSeek R1</option>
        </select>
      </div>
    </div>

    <!-- Drawer -->
    <div class="drawer-backdrop" id="drawerBackdrop"></div>
    <aside class="drawer" id="drawer">
      <div class="drawer-head">
        <div class="drawer-title">Chats</div>
        <button class="drawer-close" id="closeDrawer" title="Close">‚úï</button>
      </div>

      <button class="newchat-btn" id="newChatBtn">Ôºã New Chat</button>

      <div class="chatlist" id="chatList"></div>
    </aside>

    <!-- Chat -->
    <div class="chat-container">
      <div class="chat-messages" id="chatMessages"></div>

      <div class="input-frame">
        <div class="input-row">
          <textarea id="userInput" placeholder="Type your message here..." rows="1"></textarea>
          <button class="circle-send" id="sendBtn" type="button">‚Üë</button>
        </div>

        <!-- Bottom controls row -->
        <div class="bottom-row">
          <button class="icon-btn" id="uploadBtn" title="Upload">üìé</button>

          <div class="pill" title="Auto DeepThink">
            <span>ÿßŸÑÿ™ŸÅŸÉŸäÿ± ÿßŸÑÿπŸÖŸäŸÇ</span>
            <span class="dot off" id="deepDot"></span>
          </div>

          <div class="pill" title="External Provider">
            <span>ŸÖÿ≤ŸàÿØ ÿÆÿßÿ±ÿ¨Ÿä</span>
            <span class="dot on" id="providerDot"></span>
          </div>

          <input type="file" id="fileInput" style="display:none" />
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= Error Guard =========
    window.addEventListener("error", (e) => {
      try { addMessage("system", "‚ùå JS Error: " + (e.message || "unknown")); } catch(_) {}
    });
    window.addEventListener("unhandledrejection", (e) => {
      try { addMessage("system", "‚ùå Promise Error: " + (e.reason?.message || e.reason || "unknown")); } catch(_) {}
    });

    // ========= DOM =========
    const chatMessages = document.getElementById('chatMessages');
    const userInput    = document.getElementById('userInput');
    const sendBtn      = document.getElementById('sendBtn');
    const modelSelect  = document.getElementById('modelSelect');

    const openDrawerBtn = document.getElementById('openDrawer');
    const closeDrawerBtn = document.getElementById('closeDrawer');
    const drawerBackdrop = document.getElementById('drawerBackdrop');
    const drawer = document.getElementById('drawer');

    const newChatBtn = document.getElementById('newChatBtn');
    const chatListEl = document.getElementById('chatList');

    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');

    const deepDot = document.getElementById('deepDot');
    const providerDot = document.getElementById('providerDot');

    // ========= Copy =========
    window.copyText = function(element, text){
      navigator.clipboard.writeText(text).then(()=>{
        element.classList.add('copied');
        element.textContent = '‚úì copied';
        setTimeout(()=>{
          element.classList.remove('copied');
          element.textContent = 'copy';
        }, 1200);
      }).catch(()=> alert('Failed to copy text'));
    };

    function addMessage(role, content){
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${role}`;

      const wrapper = document.createElement('div');
      wrapper.className = 'content-wrapper';

      const contentDiv = document.createElement('div');
      contentDiv.className = 'content';
      contentDiv.textContent = String(content || "");

      wrapper.appendChild(contentDiv);

      const copyUnder = document.createElement('span');
      copyUnder.className = 'copy-under';
      copyUnder.textContent = 'copy';
      copyUnder.onclick = function(){ copyText(this, contentDiv.textContent || contentDiv.innerText); };
      wrapper.appendChild(copyUnder);

      msgDiv.appendChild(wrapper);

      const timeSpan = document.createElement('span');
      timeSpan.className = 'time';
      timeSpan.textContent = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
      msgDiv.appendChild(timeSpan);

      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // store in current chat memory
      if (currentChat && role !== "system_loader") {
        currentChat.messages.push({ role, content: String(content||""), t: Date.now() });
      }
      return msgDiv;
    }

    // ========= Loader (single blinking dot) =========
    let blinkTimer = null;
    function showBlink(){
      const el = document.createElement('div');
      el.className = 'message system';
      const wrapper = document.createElement('div');
      wrapper.className = 'content-wrapper';
      const contentDiv = document.createElement('div');
      contentDiv.className = 'content blink';
      contentDiv.textContent = "‚Ä¢";
      wrapper.appendChild(contentDiv);
      el.appendChild(wrapper);
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      let on = true;
      clearInterval(blinkTimer);
      blinkTimer = setInterval(()=>{
        on = !on;
        contentDiv.textContent = on ? "‚Ä¢" : " ";
      }, 450);

      return el;
    }
    function hideBlink(el){
      clearInterval(blinkTimer);
      blinkTimer = null;
      if(el && el.parentNode) el.parentNode.removeChild(el);
    }

    // ========= Puter ready =========
    function ensurePuter(){
      if(!window.puter) return { ok:false, why:"Puter.js ŸÑŸÖ Ÿäÿ™ÿ≠ŸÖŸëŸÑ. ÿ™ÿ£ŸÉÿØ ÿßŸÑÿßŸÜÿ™ÿ±ŸÜÿ™ Ÿàÿ≠ÿØÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©." };
      if(!puter.ai || !puter.ai.chat) return { ok:false, why:"puter.ai.chat ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ± ÿ≠ÿßŸÑŸäÿßŸã." };
      return { ok:true };
    }

    // ========= Auto DeepThink heuristic =========
    function looksScientificOrDeep(q){
      const s = String(q||"").toLowerCase();
      const keys = [
        "equation","proof","theorem","physics","quantum","relativity","cosmology","black hole","galaxy",
        "algorithm","complexity","optimize","neural","model","training","gradient","bayes","likelihood","dtw",
        "ŸÖÿπÿßÿØŸÑÿ©","ÿ®ÿ±ŸáÿßŸÜ","ÿßÿ¥ÿ™ŸÇÿßŸÇ","ŸÜÿ∏ÿ±Ÿäÿ©","ŸÅŸäÿ≤Ÿäÿßÿ°","ŸÉŸÖ","ŸÜÿ≥ÿ®Ÿäÿ©","ŸÉŸàŸÜ","ÿ´ŸÇÿ®","ŸÖÿ¨ÿ±ÿ©","ÿÆŸàÿßÿ±ÿ≤ŸÖŸäÿ©","ÿ™ÿπŸÇŸäÿØ","ÿ™ÿ≠ÿ≥ŸäŸÜ",
        "ŸÜŸÖŸàÿ∞ÿ¨","ÿ™ÿØÿ±Ÿäÿ®","ÿ®ÿßŸäÿ≤","ÿßÿ≠ÿ™ŸÖÿßŸÑ","dtw","ifm2","aic","bic","lensing","Œ∫"
      ];
      let hit = 0;
      for(const k of keys) if(s.includes(k)) hit++;
      const long = s.length >= 240;
      const multi = /[\n\r]|(\b1\)|\b2\)|\b3\)|‚Ä¢|- )/.test(s);
      return hit >= 2 || long || multi;
    }

    function setDeepDot(on){
      deepDot.classList.remove("on","off");
      deepDot.classList.add(on ? "on" : "off");
    }
    function setProviderDot(on){
      providerDot.classList.remove("on","off");
      providerDot.classList.add(on ? "on" : "off");
    }

    // ========= In-RAM chat sessions (max 10) =========
    // NOTE: this is RAM-only; disappears if page refreshes.
    const chats = [];
    let currentChat = null;

    function makeTitleFromFirstUserMsg(text){
      const t = String(text||"").trim().replace(/\s+/g," ");
      if(!t) return "New chat";
      return t.length > 26 ? (t.slice(0,26) + "‚Ä¶") : t;
    }

    function renderChatList(){
      chatListEl.innerHTML = "";
      chats.forEach((c, idx) => {
        const item = document.createElement("div");
        item.className = "chatitem" + ((currentChat && currentChat.id === c.id) ? " active" : "");
        const title = document.createElement("div");
        title.className = "title";
        title.textContent = c.title;

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `Messages: ${c.messages.length}`;

        item.appendChild(title);
        item.appendChild(meta);

        item.onclick = () => {
          switchToChat(c.id);
          closeDrawer();
        };

        chatListEl.appendChild(item);
      });
    }

    function switchToChat(id){
      const found = chats.find(x => x.id === id);
      if(!found) return;
      currentChat = found;

      // re-render messages
      chatMessages.innerHTML = "";
      for(const m of currentChat.messages){
        // rebuild bubble
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${m.role}`;

        const wrapper = document.createElement('div');
        wrapper.className = 'content-wrapper';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'content';
        contentDiv.textContent = m.content;

        wrapper.appendChild(contentDiv);

        const copyUnder = document.createElement('span');
        copyUnder.className = 'copy-under';
        copyUnder.textContent = 'copy';
        copyUnder.onclick = function(){ copyText(this, contentDiv.textContent || contentDiv.innerText); };
        wrapper.appendChild(copyUnder);

        msgDiv.appendChild(wrapper);

        const timeSpan = document.createElement('span');
        timeSpan.className = 'time';
        timeSpan.textContent = new Date(m.t).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
        msgDiv.appendChild(timeSpan);

        chatMessages.appendChild(msgDiv);
      }
      chatMessages.scrollTop = chatMessages.scrollHeight;

      renderChatList();
    }

    function startNewChat(){
      // If current chat is empty, reuse it
      if(currentChat && currentChat.messages.length === 0){
        chatMessages.innerHTML = "";
        addBootMessage();
        renderChatList();
        return;
      }

      // create
      const id = "chat_" + Math.random().toString(16).slice(2) + "_" + Date.now();
      const chat = { id, title:"New chat", createdAt: Date.now(), messages: [] };

      // add to front
      chats.unshift(chat);

      // keep only 10 chats
      while(chats.length > 10) chats.pop();

      currentChat = chat;

      chatMessages.innerHTML = "";
      addBootMessage();
      renderChatList();
    }

    function addBootMessage(){
      // avoid storing as loader/system history spam
      const msgDiv = document.createElement('div');
      msgDiv.className = `message system`;

      const wrapper = document.createElement('div');
      wrapper.className = 'content-wrapper';

      const contentDiv = document.createElement('div');
      contentDiv.className = 'content';
      contentDiv.textContent = "Welcome to the infinite space! ‚ú®";

      wrapper.appendChild(contentDiv);

      const copyUnder = document.createElement('span');
      copyUnder.className = 'copy-under';
      copyUnder.textContent = 'copy';
      copyUnder.onclick = function(){ copyText(this, contentDiv.textContent || contentDiv.innerText); };
      wrapper.appendChild(copyUnder);

      msgDiv.appendChild(wrapper);

      const timeSpan = document.createElement('span');
      timeSpan.className = 'time';
      timeSpan.textContent = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
      msgDiv.appendChild(timeSpan);

      chatMessages.appendChild(msgDiv);

      // store it
      if(currentChat){
        currentChat.messages.push({ role:"system", content:"Welcome to the infinite space! ‚ú®", t: Date.now() });
      }
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ========= Drawer controls =========
    function openDrawer(){
      d
